@startuml
' Order Controller - ACTUAL IMPLEMENTATION
skinparam componentStyle rectangle

package "Clients" {
  [Customer App] <<component>>
  [Restaurant Panel] <<component>>
  [Admin Panel] <<component>>
}

package "Backend (Express)" {
  [Order Controller] <<component>>
  [Auth Middleware] <<component>>
}

database "MongoDB" {
  [orders collection] <<database>>
  [users collection] <<database>>
}

artifact "Stripe" as Stripe

' Client interactions
[Customer App] --> [Auth Middleware] : POST /api/order/place (token)
[Customer App] --> [Auth Middleware] : POST /api/order/verify
[Customer App] --> [Auth Middleware] : POST /api/order/userorders
[Customer App] --> [Auth Middleware] : POST /api/order/confirm-delivery

[Restaurant Panel] --> [Auth Middleware] : GET /api/order/list
[Restaurant Panel] --> [Auth Middleware] : POST /api/order/status
[Restaurant Panel] --> [Auth Middleware] : POST /api/order/cancel

[Admin Panel] --> [Auth Middleware] : GET /api/order/list
[Admin Panel] --> [Auth Middleware] : POST /api/order/status
[Admin Panel] --> [Auth Middleware] : POST /api/order/cancel

' Middleware to Controller
[Auth Middleware] --> [Order Controller] : verify JWT & pass userId

' Order operations
[Order Controller] --> Stripe : create checkout session
Stripe --> [Order Controller] : redirect to payment page
[Order Controller] --> Stripe : retrieve session (verify payment)
[Order Controller] --> [orders collection] : save order after payment
[Order Controller] --> [orders collection] : find orders by userId
[Order Controller] --> [orders collection] : update order status
[Order Controller] --> [users collection] : clear cart after order
[Order Controller] --> [users collection] : check admin/restaurant role

note right of [Order Controller]
  **placeOrder**: Creates Stripe checkout session,
  stores order data in metadata, clears cart
  
  **verifyOrder**: Retrieves session, confirms payment,
  creates order in DB only if paid
  
  **userOrders**: Get user's orders
  
  **listOrders**: Admin/Restaurant view all orders
  
  **updateStatus**: Change order status
  (Food Processing → Out for delivery → Delivered)
  
  **cancelOrder**: Cancel with reason (admin/restaurant)
  
  **confirmDelivery**: Customer confirms delivery
end note

note left of Stripe
  Uses Stripe Checkout (not Payment Intent)
  No webhooks implemented
  Payment verified via session retrieval
end note

actor Customer
actor Restaurant
actor Admin
Customer --> [Customer App]
Restaurant --> [Restaurant Panel]
Admin --> [Admin Panel]

@enduml
