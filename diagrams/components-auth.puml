@startuml
' User Controller & Auth - ACTUAL IMPLEMENTATION
skinparam componentStyle rectangle

package "Clients" {
  [Customer App] <<component>>
  [Admin Panel] <<component>>
  [Restaurant Panel] <<component>>
}

package "Backend (Express)" {
  [User Controller] <<component>>
  [Auth Middleware] <<component>>
}

database "MongoDB" {
  [users collection] <<database>>
}

library "jsonwebtoken" as JWT
library "bcrypt" as Bcrypt

' Client interactions
[Customer App] --> [User Controller] : POST /api/user/register
[Customer App] --> [User Controller] : POST /api/user/login
[Admin Panel] --> [User Controller] : POST /api/user/login
[Restaurant Panel] --> [User Controller] : POST /api/user/login

' Special admin setup
[Admin Panel] --> [User Controller] : POST /api/user/makeAdmin (with secret)

' Auth operations
[User Controller] --> Bcrypt : hash password (register)
[User Controller] --> Bcrypt : compare password (login)
[User Controller] --> JWT : sign token (after login)
[User Controller] --> [users collection] : create user
[User Controller] --> [users collection] : find user by email
[User Controller] --> [users collection] : update user role

' Auth middleware usage
[Auth Middleware] --> JWT : verify token
[Auth Middleware] --> [users collection] : decode userId from token

note right of [User Controller]
  **registerUser**: Hash password with bcrypt,
  save to DB, return JWT token
  
  **loginUser**: Find by email, compare password,
  return JWT token + role
  
  **makeAdmin**: Temporary endpoint to promote
  user to admin (requires ADMIN_SETUP_SECRET)
  
  Token contains: userId (as _id)
  User roles: "user", "admin", "restaurant"
end note

note left of [Auth Middleware]
  Middleware: auth.js
  
  Reads token from request header
  Verifies JWT with secret
  Decodes userId and adds to req.body
  
  No refresh tokens
  No session storage
  No Redis
end note

note bottom of [users collection]
  Schema includes:
  - name, email, password (hashed)
  - role: "user" | "admin" | "restaurant"
  - cartData: {} (embedded cart)
  - createdAt
end note

actor Customer
actor Admin
actor Restaurant
Customer --> [Customer App]
Admin --> [Admin Panel]
Restaurant --> [Restaurant Panel]

@enduml
