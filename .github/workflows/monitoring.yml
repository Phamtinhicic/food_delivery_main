name: CI/CD Monitoring

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build-and-test:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: backend/package-lock.json

      - name: Install dependencies
        working-directory: ./backend
        run: |
          npm ci
          echo "BUILD_START=$(date +%s)" >> $GITHUB_ENV

      - name: Run tests
        working-directory: ./backend
        run: |
          npm test
          echo "TEST_RESULT=$?" >> $GITHUB_ENV
          echo "TEST_END=$(date +%s)" >> $GITHUB_ENV

      - name: Calculate metrics
        id: metrics
        run: |
          # Build duration
          BUILD_END=$(date +%s)
          BUILD_DURATION=$((BUILD_END - BUILD_START))
          
          # Commit info
          COMMITS=$(git rev-list --count HEAD)
          FILES_CHANGED=$(git diff-tree --no-commit-id --name-only -r HEAD | wc -l)
          LINES_ADDED=$(git diff HEAD~1 HEAD --numstat | awk '{sum+=$1} END {print sum+0}')
          LINES_REMOVED=$(git diff HEAD~1 HEAD --numstat | awk '{sum+=$2} END {print sum+0}')
          
          # Test duration
          TEST_DURATION=$((TEST_END - BUILD_START))
          
          echo "build_duration=$BUILD_DURATION" >> $GITHUB_OUTPUT
          echo "test_duration=$TEST_DURATION" >> $GITHUB_OUTPUT
          echo "commits=$COMMITS" >> $GITHUB_OUTPUT
          echo "files_changed=$FILES_CHANGED" >> $GITHUB_OUTPUT
          echo "lines_added=$LINES_ADDED" >> $GITHUB_OUTPUT
          echo "lines_removed=$LINES_REMOVED" >> $GITHUB_OUTPUT

      - name: Push CI/CD metrics to Pushgateway
        env:
          PUSHGATEWAY_URL: ${{ secrets.PUSHGATEWAY_URL }}
        run: |
          # Determine build status
          if [ "${{ job.status }}" == "success" ]; then
            BUILD_STATUS=1
            TEST_STATUS=1
          else
            BUILD_STATUS=0
            TEST_STATUS=0
          fi
          
          # Push metrics
          cat <<EOF | curl --data-binary @- ${PUSHGATEWAY_URL}/metrics/job/cicd/instance/${GITHUB_REPOSITORY}
          # HELP cicd_build_status Build status (1=success, 0=failure)
          # TYPE cicd_build_status gauge
          cicd_build_status{repository="${GITHUB_REPOSITORY}",branch="${GITHUB_REF_NAME}",commit="${GITHUB_SHA:0:7}"} ${BUILD_STATUS}
          
          # HELP cicd_build_duration_seconds Build duration in seconds
          # TYPE cicd_build_duration_seconds gauge
          cicd_build_duration_seconds{repository="${GITHUB_REPOSITORY}",branch="${GITHUB_REF_NAME}"} ${{ steps.metrics.outputs.build_duration }}
          
          # HELP cicd_test_status Test status (1=passed, 0=failed)
          # TYPE cicd_test_status gauge
          cicd_test_status{repository="${GITHUB_REPOSITORY}",branch="${GITHUB_REF_NAME}"} ${TEST_STATUS}
          
          # HELP cicd_test_duration_seconds Test duration in seconds
          # TYPE cicd_test_duration_seconds gauge
          cicd_test_duration_seconds{repository="${GITHUB_REPOSITORY}",branch="${GITHUB_REF_NAME}"} ${{ steps.metrics.outputs.test_duration }}
          
          # HELP cicd_total_commits Total number of commits
          # TYPE cicd_total_commits gauge
          cicd_total_commits{repository="${GITHUB_REPOSITORY}",branch="${GITHUB_REF_NAME}"} ${{ steps.metrics.outputs.commits }}
          
          # HELP cicd_files_changed Files changed in last commit
          # TYPE cicd_files_changed gauge
          cicd_files_changed{repository="${GITHUB_REPOSITORY}",branch="${GITHUB_REF_NAME}"} ${{ steps.metrics.outputs.files_changed }}
          
          # HELP cicd_lines_added Lines added in last commit
          # TYPE cicd_lines_added gauge
          cicd_lines_added{repository="${GITHUB_REPOSITORY}",branch="${GITHUB_REF_NAME}"} ${{ steps.metrics.outputs.lines_added }}
          
          # HELP cicd_lines_removed Lines removed in last commit
          # TYPE cicd_lines_removed gauge
          cicd_lines_removed{repository="${GITHUB_REPOSITORY}",branch="${GITHUB_REF_NAME}"} ${{ steps.metrics.outputs.lines_removed }}
          
          # HELP cicd_pipeline_timestamp Pipeline execution timestamp
          # TYPE cicd_pipeline_timestamp gauge
          cicd_pipeline_timestamp{repository="${GITHUB_REPOSITORY}",branch="${GITHUB_REF_NAME}"} $(date +%s)
          EOF

      - name: Notify on failure
        if: failure()
        run: |
          echo "Build or tests failed! Check Grafana dashboard for details."
